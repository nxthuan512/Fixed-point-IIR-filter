% ====================================================================
% HW model of IIR based on 
% https://flylib.com/books/en/2.729.1/improving_iir_filters_with_cascaded_structures.html
%   Ver01 - 2018/11/29 - Thomas
% ====================================================================
function iir_4_float_hw
    % Frequency band
    freq_band = [0.1 4; 4 8; 8 16; 16 32; 32 64];
    freq_band_n = size(freq_band, 1);
    
    % Sampling frequency and time axis
    samp_freq = 256;
    t = 0:1/samp_freq:10-(1/samp_freq);
    
    % Coefficients
    gain = [2.150542712e+05; 1.951902201e+05; 1.374144198e+04; 1.071238751e+03; 9.794817380e+01];
    b_iir = [4, 6]; % 
    a_iir = [7.7489823106 -26.2747816420 50.9176975860 -61.6812334420 47.8292093390 -23.1841071240 6.4228457444 -0.7786127726; % a6 .. a1
             %7.7982049030 -26.6165138410 51.9342767450 -63.3610010480 49.4943361550 -24.1743651410 6.7499910028 -0.8249287765;
             7.6689325586 -25.8057691120 49.7648494220 -60.1543544250 46.6712574130 -22.6972292260 6.3259414679 -0.7736282195;
             7.1995747040 -22.9516383590 42.3036990870 -49.3006217250 37.1979564460 -17.7464274520 4.8954955737 -0.5980652616;
             5.9146830291 -16.1669484310 26.5103840790 -28.4580990520 20.4604845180 -9.63001583590 2.7199638582 -0.3555773823;
             2.4722037354 -4.30887809680 4.88624356960 -4.47660392870 2.91359349750 -1.51912961100 0.4995536633 -0.1203895999];
    
    % Read files
    fx = fopen('input_x.dat','r');
    x = fscanf(fx, '%f');
        
    n_row = length(freq_band);
    n_col = 9;
    n = length(x);
    y = zeros(freq_band_n, length(x)); 

    % Signal energy of n frequency band
    for j = 1:freq_band_n
    %for j = 1:1
        xx = zeros(1, n_col);
        yy = zeros(1, n_col);
        for i = 1:n     
            xx(1) = xx(2);
            xx(2) = xx(3);
            xx(3) = xx(4);
            xx(4) = xx(5);
            xx(5) = xx(6);
            xx(6) = xx(7);
            xx(7) = xx(8);
            xx(8) = xx(9);
            xx(9) = x(i)/gain(j);
            
            yy(1) = yy(2);
            yy(2) = yy(3);
            yy(3) = yy(4);
            yy(4) = yy(5);
            yy(5) = yy(6);
            yy(6) = yy(7);                 
            yy(7) = yy(8);
            yy(8) = yy(9);
            yy(9) =  (xx(1) + xx(9)) - b_iir(1)*(xx(3) + xx(7)) + b_iir(2) * xx(5) ...
                 + ( a_iir(j, 8) * yy(1)) + ( a_iir(j, 7) * yy(2)) ...
                 + ( a_iir(j, 6) * yy(3)) + ( a_iir(j, 5) * yy(4)) ...
                 + ( a_iir(j, 4) * yy(5)) + ( a_iir(j, 3) * yy(6)) ...
                 + ( a_iir(j, 2) * yy(7)) + ( a_iir(j, 1) * yy(8));
               
            y(j, i) = yy(9);
                                     
        end
    end
end